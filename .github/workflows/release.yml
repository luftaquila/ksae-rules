name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    uses: ./.github/workflows/build.yml

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get tag info
      id: tag
      run: |
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        echo "current=$CURRENT_TAG" >> $GITHUB_OUTPUT

        CURRENT_YEAR=$(echo "$CURRENT_TAG" | cut -d'-' -f1)
        echo "year=$CURRENT_YEAR" >> $GITHUB_OUTPUT

        PREV_TAG=$(git tag --sort=-version:refname | while read tag; do
          TAG_YEAR=$(echo "$tag" | cut -d'-' -f1)
          if [ "$TAG_YEAR" != "$CURRENT_YEAR" ]; then
            echo "$tag"
            break
          fi
        done)

        if [ -n "$PREV_TAG" ]; then
          PREV_YEAR=$(echo "$PREV_TAG" | cut -d'-' -f1)
          echo "previous=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "previous_year=$PREV_YEAR" >> $GITHUB_OUTPUT
          echo "has_previous=true" >> $GITHUB_OUTPUT
        else
          echo "has_previous=false" >> $GITHUB_OUTPUT
        fi

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: build/

    - name: Prepare release files
      run: |
        cp build/formula.pdf "formula(${{ steps.tag.outputs.current }}).pdf"

        mkdir -p web/fonts
        cp build/formula.html web/index.html
        cp build/style.css web/
        cp -r build/assets web/ 2>/dev/null || true
        cp -r build/_site/fonts/* web/fonts/ 2>/dev/null || true
        cd web && zip -r "../formula(${{ steps.tag.outputs.current }}).zip" .

    - name: Prepare diff
      if: steps.tag.outputs.has_previous == 'true'
      run: |
        git show ${{ steps.tag.outputs.previous }}:formula.tex > formula_old.tex
        git show ${{ steps.tag.outputs.previous }}:template.tex > template_old.tex 2>/dev/null || cp template.tex template_old.tex

    - name: Install fonts for diff
      if: steps.tag.outputs.has_previous == 'true'
      run: |
        mkdir -p fonts
        wget -q https://hangeul.naver.com/hangeul_static/webfont/zips/nanum-myeongjo.zip
        unzip -q nanum-myeongjo.zip
        mv *.ttf fonts/
        wget -q https://github.com/orioncactus/pretendard/releases/download/v1.3.9/Pretendard-1.3.9.zip
        unzip -q Pretendard-1.3.9.zip
        mv public/static/alternative/*.ttf fonts/
        wget -q https://github.com/notofonts/noto-cjk/raw/refs/heads/main/Sans/OTF/TraditionalChinese/NotoSansCJKtc-Regular.otf
        mv *.otf fonts/

    - name: Create diff PDF
      if: steps.tag.outputs.has_previous == 'true'
      uses: xu-cheng/latex-action@v3
      with:
        root_file: diff.tex
        latexmk_use_lualatex: true
        extra_fonts: fonts/*
        pre_compile: |
          latexdiff --type=UNDERLINE formula_old.tex formula.tex > diff.tex

    - name: Rename diff PDF
      if: steps.tag.outputs.has_previous == 'true'
      run: |
        mv diff.pdf "formula-diff(${{ steps.tag.outputs.previous_year }}-${{ steps.tag.outputs.year }}).pdf"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          formula(${{ steps.tag.outputs.current }}).pdf
          formula(${{ steps.tag.outputs.current }}).zip
          formula-diff(${{ steps.tag.outputs.previous_year }}-${{ steps.tag.outputs.year }}).pdf
        fail_on_unmatched_files: false
        generate_release_notes: true
