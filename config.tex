% packages
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{enumitem}
\usepackage{etoolbox}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{titlesec}
\usepackage{indentfirst}

% fonts
\setmainfont{NanumMyeongjo}[
  UprightFont     = {NanumMyeongjo},
  BoldFont        = {NanumMyeongjo Bold},
  ExtraBoldFont   = {NanumMyeongjo ExtraBold},
  ItalicFont      = {NanumMyeongjo},
  ItalicFeatures  = {FakeSlant=0.2},
  LetterSpace=3
]

\linespread{1.3}\selectfont

\newfontfamily\texteb{NanumMyeongjo ExtraBold}
\newfontfamily\pretendard{Pretendard}
\newfontfamily\pretendardb{Pretendard Bold}
\newfontfamily\pretendardeb{Pretendard ExtraBold}

\makeatletter
  \spaceskip=1.5\fontdimen2\font
             plus 0.3\fontdimen3\font
             minus 0.2\fontdimen4\font
\makeatother

% margins
\usepackage[margin=2cm,bottom=3.5cm]{geometry}
\typeout{>>> \string\footskip\ is \the\footskip}

% borders
\usetikzlibrary{calc}
\AddToHook{shipout/background}{%
  \begin{tikzpicture}[remember picture,overlay]
    \draw[line width=0.5pt]
      ($(current page.north west)+(1cm,-1cm)$) rectangle
      ($(current page.south east)+(-1cm,1.8cm)$);
  \end{tikzpicture}%
}

% graphics
\pagestyle{fancy}
\fancyhf{}

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

\newlength{\borderoffset}
\setlength{\borderoffset}{1cm}
\newlength{\margin}
\setlength{\margin}{2cm}

\makeatletter
\newcommand{\setupfancy}{
  \fancyhfoffset[L]{\dimexpr\margin-\borderoffset\relax}
  \fancyhfoffset[R]{\dimexpr\margin-\borderoffset\relax}
  \lfoot{\pretendardb{자동차공학은 한국의 힘!}}
  \cfoot{\pretendardb{\thepage}}
  \rfoot{\pretendardb{사단법인 한국자동차공학회}}
}
\makeatother
\setupfancy
\fancypagestyle{plain}{\setupfancy}

\setlength{\headheight}{45pt}

\makeatletter
\newcommand{\SidePaddedBox}[5]{
  \fcolorbox{black}{gray}{
    \vbox{
      \vskip #1
      \hbox{
        \hskip #2
        \color{white}\textbf{\small #5}
        \hskip #3
      }
      \vskip #4
    }
  }
}
\makeatother

\fancypagestyle{firstpage}{
  \fancyheadoffset[L]{\dimexpr\margin-\borderoffset+0.5cm\relax}
  \fancyfootoffset[L]{\dimexpr\margin-\borderoffset\relax}
  \lhead{
    \SidePaddedBox{1pt}{10pt}{40pt}{1pt}{\pretendard\fontsize{10}{12}\selectfont 한국자동차공학회 규정}
  }
  \renewcommand{\headrulewidth}{0pt}
}
\thispagestyle{firstpage}

% chapters
\makeatletter
\patchcmd{\chapter}
  {\if@openright\cleardoublepage\else\clearpage\fi}
  {}{}{}
\patchcmd{\chapter}
  {\thispagestyle{plain}}
  {}{}{}
\makeatother

\renewcommand{\chaptermark}[1]{}
\titleformat{\chapter}[hang]
  {\pretendardb\fontsize{12}{16}\selectfont}
  {제\arabic{chapter}장}
  {0.5em}
  {}
\titlespacing*{\chapter}{0pt}{3ex}{1ex}
\pagestyle{plain}

% sections
\counterwithout{section}{chapter}
\renewcommand\thesection{\arabic{section}}
\newcommand{\lawformat}[1]{\mbox{제\thesection{}조 (#1)}}
\titleformat{\section}[block]
  {}
  {}
  {0pt}
  {\lawformat}
\titlespacing*{\section}{0pt}{3ex}{1ex}

% items
\DeclareRobustCommand*{\Circlenum}{%
  \ifcase\value{enumi}\relax
  \or ①\or ②\or ③\or ④\or ⑤\or ⑥\or ⑦\or ⑧\or ⑨\or ⑩%
  \else
    \arabic{enumi}
  \fi
}
\renewcommand{\theenumi}{\Circlenum}
\renewcommand{\labelenumi}{\normalfont\Circlenum}
\setlist[enumerate,1]{ref={제\thesection{}조~\arabic*항},labelsep=0.5em,itemsep=0pt,leftmargin=3em}

% texts
\sloppy
\setlength{\leftskip}{1.5em}
\setlength{\parindent}{0pt}

% hyperlinks
\usepackage[unicode,
            pdfencoding=auto,
            bookmarks=true,
            bookmarksnumbered=true,
            bookmarksopen=true,
            bookmarkstype=toc]{hyperref}
\newcommand{\hypref}[1]{\hyperref[#1]{\ref*{#1}}}

% bookmarks
\usepackage{bookmark}
\makeatletter
\pdfstringdefDisableCommands{
  \def\thechapter{제\arabic{chapter}장}
  \def\thesection{제\arabic{section}조}
}
\makeatother
